# Video Analyzer 重构路线图（无适配器方案）

## 总体目标
- 构建与《分析模块设计目标与要点.md》一致的新架构：核心由 Source → Analyzer → Encoder → Transport 组成，统一由 Pipeline 调度。
- 重塑配置中心（app/profiles/models/analyzer_params），支持 Profile 驱动的流与任务管理。
- 在确保现有功能可灰度切换的前提下，移除旧有适配器层，实现更直接的模块协作。

## 阶段划分

### 阶段 0：基线梳理与并行机制（进行中）
- 梳理现有代码入口（`main.cpp`、`VideoAnalyzer.cpp`、REST API）。
- 定义新旧架构并行策略：保持现有可运行路径，同时为新版 Pipeline 预留编译标志或运行时开关。
- 交付物：路线图（本文档）、关键基线指标清单（待建）。

### 阶段 1：骨架搭建（核心）
- 目录重整：`core/`、`analyzer/`、`media/`、`server/` 目录下的头/源文件骨架全部创建。
- 定义核心类型与接口：
  - `core`: `EngineManager`、`Factories`、`Pipeline`、`PipelineBuilder`、`TrackManager` 等。
  - `analyzer`: `Analyzer` 实现（组合 IPreprocessor/IModelSession/IPostprocessor/IRenderer）、CPU/CUDA 预处理占位、ONNX 会话封装。
  - `media`: RTSP Source、FFmpeg Encoder、WHIP Transport 接口与空实现。
  - `server`: REST 适配新版 TrackManager 的 handler 骨架。
- 配置文件：在 `config/` 下新增 `app.yaml`、`profiles.yaml`、`models.yaml`、`analyzer_params.yaml` 的示例与解析器占位。
- CMake：拆分源文件注册，保证新增骨架可编译（尽管函数体可能返回 `false` 或 `TODO`）。
- 交付物：可编译的骨架工程；REST/主程序仍走旧逻辑，但可编译通过。

### 阶段 2：功能打通（分析链路）
- 实现 CPU 预处理（letterbox）、ONNX Runtime Session（支持 GPU IOBinding）、YOLO/DETR 后处理、Renderer。
- 将 Pipeline 替换原 `VideoAnalyzer::processFrame` 路径，保证检测结果与旧版一致。
- 提供模型切换/参数调整 API，对应 config 中 `models`、`analyzer_params`。
- 交付物：新版 Pipeline 完整跑通 RTSP→检测→渲染→WebRTC；可通过配置切换模型。

### 阶段 3：媒体链路强化
- 深化 FFmpeg 解码/编码实现，支持硬件加速选项与码率配置。
- 补齐 WHIP 传输流程，验证与前端 WebRTC 互通。
- 引入监控指标（FPS、延迟、帧计数）接入现有 REST `/api/pipelines`、`/api/system/stats`。
- 交付物：稳定的媒体管线，满足“性能、低延迟”目标。

### 阶段 4：编排与高级特性
- TrackManager 支持多流多 Profile 管理、动态热切换（Source/Model/Task）。
- EngineManager 实现 EP（CUDA/TensorRT/CPU）切换与预热。
- 加入配置热加载与安全策略（来源白名单、限流）。
- 交付物：满足《分析模块设计目标与要点.md》提出的所有可管理性与扩展性要求。

## 风险与应对
- **依赖完整性**：FFmpeg/ONNX/CUDA 版本差异 → 在 CMake 中加入可选编译、运行时能力探测。
- **并行期兼容**：旧视频分析流程需要与新 Pipeline 共存 → 增加运行时开关与日志标记，逐步迁移。
- **性能回归**：GPU 路径需配合 IOBinding、零拷贝 → 阶段 2 完善性能测试基准。

## 下一步
- 按阶段 1 计划补齐所有骨架文件与 CMake 注册。
- 设计配置解析器接口（返回结构体供 PipelineBuilder 使用）。
- 建立阶段验收清单，配合文档跟踪进展。

