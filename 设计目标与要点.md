# ç›®æ ‡ä¸è¦ç‚¹

- **æŒ‰éœ€ç”Ÿäº§ + ç»Ÿä¸€åˆ†å‘**ï¼šåç«¯å¯¹æ¯æ¡â€œæµ+Profileâ€åª**ç¼–ç /å‘å¸ƒä¸€æ¬¡**åˆ° SFUï¼ˆæ¨è MediaMTXï¼‰ï¼›N ä¸ªå‰ç«¯é€šè¿‡ **WHEP** æ‹‰æµï¼Œä¸å¢åŠ åç«¯ç¼–ç æˆæœ¬ã€‚ä¸Šè¡Œåè®®ç”¨ **WHIP**ï¼ˆIETF æ ‡å‡† RFC 9725ï¼‰ï¼Œä¸‹è¡Œåè®®ç”¨ **WHEP**ï¼ˆIETF å·¥ä½œè‰æ¡ˆï¼‰ã€‚[rfc-editor.org+1](https://www.rfc-editor.org/rfc/rfc9725.pdf?utm_source=chatgpt.com)
- **è¿è¡ŒæœŸåŠ¨æ€åˆ‡æ¢**ï¼ˆç§’çº§ã€ä¸æ–­æµï¼‰ï¼š
   æºï¼ˆRTSP URLï¼‰/ åŒç±»æ¨¡å‹ï¼ˆyolov12lâ†’yolov12xï¼‰/ è·¨æ—æ¨¡å‹ï¼ˆYOLOâ†’DETRï¼‰/ ä»»åŠ¡ï¼ˆæ£€æµ‹â†”åˆ†å‰²ï¼‰/ å‚æ•°ï¼ˆconfã€IoUã€ç±»ç™½åå•ï¼‰/ **å…¨å±€æ¨ç†å¼•æ“ï¼ˆCUDA/TensorRT/CPUï¼‰**ã€‚
- **Analyzer å››æ®µå¼**ï¼š**é¢„å¤„ç† â†’ æ¨ç†ï¼ˆä¼šè¯/å¼•æ“ï¼‰ â†’ åå¤„ç† â†’ æ¸²æŸ“**ï¼ŒåŸå­çƒ­æ’æ‹”ã€‚
- **å…³é”®æŠ€æœ¯é€‰æ‹©**ï¼š
  - FFmpeg ç°ä»£ **send/receive** API åšè§£ç ä¸ç¼–ç ï¼ˆä½å»¶è¿Ÿã€å¯æ§èƒŒå‹ï¼‰ã€‚[ffmpeg.org+1](https://www.ffmpeg.org/doxygen/4.1/group__lavc__encdec.html?utm_source=chatgpt.com)
  - ONNX Runtime ç»Ÿä¸€ä¼šè¯ï¼›é€šè¿‡ **Execution Provider** é€‰æ‹© CUDA / TensorRT / CPUï¼›ä½¿ç”¨ **IOBinding** æŠŠ I/O ç›´æ¥ç»‘å®šåœ¨ GPU å†…å­˜ï¼Œå‡å°‘æ‹·è´ä¸æ—¶å»¶ã€‚[onnxruntime.ai+3onnxruntime.ai+3onnxruntime.ai+3](https://onnxruntime.ai/docs/execution-providers/?utm_source=chatgpt.com)
  - NMS/é˜ˆå€¼ç­‰æ¨ç†å‚æ•°å¯è°ƒï¼ˆYOLO ç³»åˆ—å°¤ä¸ºé‡è¦ï¼‰ï¼›DETR ä¸€èˆ¬**æ— éœ€ NMS**ï¼ˆä¸€å¯¹ä¸€åŒ¹é…å»ºæ¨¡ï¼‰ã€‚[docs.ultralytics.com+2docs.ultralytics.com+2](https://docs.ultralytics.com/modes/predict/?utm_source=chatgpt.com)

------

# æ¶æ„ï¼ˆæ•°æ®é¢ + æ§åˆ¶é¢ï¼‰

```
[REST æ§åˆ¶é¢]
/subscribe /unsubscribe
/source/switch        åˆ‡æº (é¢„çƒ­â†’åŸå­æ›¿æ¢)
/model/switch         åŒç±»/è·¨æ—æ¨¡å‹åˆ‡æ¢ (é¢„çƒ­æ–°ä¼šè¯â†’åŸå­æ›¿æ¢)
/task/switch          åˆ‡ä»»åŠ¡ (æ›¿æ¢åå¤„ç†/æ¸²æŸ“å™¨)
/model/params         çƒ­æ›´æ–°é˜ˆå€¼/ROIç­‰ (å¿«ç…§)
/engine/set           å…¨å±€EPåˆ‡æ¢ (æ‰¹é‡é¢„çƒ­â†’åˆ†æ‰¹A/Bâ†’å›æ”¶)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Orchestrator / TrackManager            â”‚  â† æŒ‰éœ€åˆ›å»º/å›æ”¶â€œæµ+Profileâ€å°ç®¡çº¿
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     WHIP (ä¸€æ¬¡å‘å¸ƒ)
â”‚ Pipeline(stream, profile)              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  MediaMTX (SFU)
â”‚  Switchable RTSP â†’ FFmpeg Decode â†’     â”‚                   â–²
â”‚  Analyzer(é¢„å¤„ç†â†’ä¼šè¯â†’åå¤„ç†â†’æ¸²æŸ“) â†’   â”‚                   â”‚ WHEP (å¤šå®¢æˆ·ç«¯)
â”‚  FFmpeg Encode â†’ WHIP Publish          â”‚                   â–¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              æµè§ˆå™¨/åŸç”Ÿå®¢æˆ·ç«¯
```

- **WHIP/WHEP**ï¼šé¢å‘ WebRTC çš„ HTTP ä¸Š/ä¸‹è¡Œåè®®ï¼›WHIP å·²æ ‡å‡†åŒ–ï¼ŒWHEP æ­£åœ¨ IETF è¿‡ç¨‹å¹¶æœ‰ç¤¾åŒºå®ç°ã€‚[rfc-editor.org+1](https://www.rfc-editor.org/rfc/rfc9725.pdf?utm_source=chatgpt.com)

------

# ä»£ç ç»“æ„ï¼ˆç›®å½•éª¨æ¶ï¼‰

```
va/
â”œâ”€ CMakeLists.txt
â”œâ”€ config/
â”‚   â”œâ”€ app.yaml              # å…¨å±€å¼•æ“/å›æ”¶/å®‰å…¨/è§‚æµ‹/SFUåŸºå€
â”‚   â”œâ”€ profiles.yaml         # Profile æ¨¡æ¿ï¼ˆä»»åŠ¡+ç¼–ç +å‘å¸ƒï¼‰
â”‚   â”œâ”€ models.yaml           # æ¨¡å‹ä»“åº“æ˜ å°„ï¼ˆtask/family/variant -> onnxï¼‰
â”‚   â””â”€ analyzer_params.yaml  # é»˜è®¤æ¨ç†å‚æ•°ï¼ˆå¯ PATCH çƒ­æ›´ï¼‰
â””â”€ src/
    â”œâ”€ main.cpp                  # å…¥å£ + REST è·¯ç”±
    â”œâ”€ composition_root.cpp      # ç»„åˆæ ¹ï¼šæ³¨å†Œæ˜¾å¼å·¥å‚ï¼ˆæ— åå°„ï¼‰
    â”œâ”€ factories.hpp             # å·¥å‚è¡¨ï¼ˆSource/Filter/Encoder/Transportï¼‰
    â”œâ”€ engine_manager.hpp        # å…¨å±€ EP ç®¡ç†ï¼ˆORT EP åˆ‡æ¢ï¼‰
    â”œâ”€ engine_ort.hpp            # ORT ä¼šè¯å°è£…ï¼ˆCUDA/TensorRT EP & IOBindingï¼‰
    â”œâ”€ analyzer.hpp              # Analyzer(é¢„å¤„ç†/ä¼šè¯/åå¤„ç†/æ¸²æŸ“) åŸå­çƒ­æ’æ‹”
    â”œâ”€ preproc_*.{hpp,cpp}       # Letterbox(NPP/CPU)ã€Normalize
    â”œâ”€ postproc_yolo.{hpp,cpp}   # è§£ç +NMSï¼ˆdetï¼‰/ proto+coefï¼ˆsegï¼‰
    â”œâ”€ postproc_detr.{hpp,cpp}   # logits+boxesï¼Œé€šå¸¸æ— NMS
    â”œâ”€ render_{box,mask}.cpp     # å åŠ å™¨ï¼›æˆ–äº§JSONç»™å‰ç«¯
    â”œâ”€ ffmpeg_decode.{hpp,cpp}   # send/receive è§£ç 
    â”œâ”€ ffmpeg_encode.{hpp,cpp}   # send/receive ç¼–ç  (x264/NVENC)
    â”œâ”€ transport_whip.{hpp,cpp}  # WHIP å®¢æˆ·ç«¯
    â”œâ”€ pipeline.{hpp,cpp}        # å¸§å¾ªç¯çº¿ç¨‹ + é˜Ÿåˆ—/èƒŒå‹
    â”œâ”€ track_manager.{hpp,cpp}   # æŒ‰éœ€åˆ›å»º/å›æ”¶ + åŠ¨æ€åˆ‡æ¢
    â””â”€ utils.hpp                 # Frame/TensorView/LetterboxMeta/è®¡æ—¶/æ—¥å¿—
```

------

# æ ¸å¿ƒæ¥å£ï¼ˆç¨³å®šæŠ½è±¡ï¼‰

```c++
// æ•°æ®ä¸ç»“æœ
struct Frame { int w=0,h=0; double pts_ms=0; std::vector<uint8_t> bgr; };
struct LetterboxMeta { float scale; int pad_x; int pad_y; int in_w; int in_h; };
struct TensorView { void* data; std::vector<int64_t> shape; bool on_gpu; int dtype; };

struct ModelOutput {
  struct Box { float x1,y1,x2,y2,score; int cls; };
  std::vector<Box> boxes;
  std::vector<std::vector<uint8_t>> masks; // å¯é€‰ï¼šå®ä¾‹åˆ†å‰²æ©ç 
};

// å››æ®µå¼ Analyzer
struct IPreprocessor   { virtual bool run(const Frame&, TensorView&, LetterboxMeta&)=0; virtual ~IPreprocessor()=default; };
struct IModelSession   { virtual bool run(const TensorView&, std::vector<TensorView>&)=0; virtual ~IModelSession()=default; };
struct IPostprocessor  { virtual bool run(const std::vector<TensorView>&, const LetterboxMeta&, ModelOutput&)=0; virtual ~IPostprocessor()=default; };
struct IRenderer       { virtual bool draw(const Frame&, const ModelOutput&, Frame&)=0; virtual ~IRenderer()=default; };

// å¤–å£³ï¼šå¯çƒ­æ’æ‹”
struct AnalyzerParams { float conf=0.25f, iou=0.50f; std::vector<int> classes; /* roi, mask_thresh... */ };

class Analyzer : public IFrameFilter {
  std::atomic<std::shared_ptr<IPreprocessor>>  pre_;
  std::atomic<std::shared_ptr<IModelSession>>  sess_;
  std::atomic<std::shared_ptr<IPostprocessor>> post_;
  std::atomic<std::shared_ptr<IRenderer>>      ren_;
  std::atomic<std::shared_ptr<AnalyzerParams>> params_;
  // process(): é¢„å¤„ç†â†’ä¼šè¯â†’åå¤„ç†â†’(å¯é€‰)æ¸²æŸ“ï¼›æ‰€æœ‰æˆå‘˜ç”¨ acquire/release è¯»å–
};

// å…¶ä»–ç¨³å®šæ¥å£
struct IFrameSource { virtual bool grab(Frame&)=0; virtual ~IFrameSource()=default; };
struct ISwitchableSource : IFrameSource { virtual bool switch_to(const std::string& url)=0; };
struct IEncoder     { struct EncodedChunk{std::vector<uint8_t> data; bool key=false; double pts_ms=0;};
                      virtual bool encode(const Frame&, std::vector<EncodedChunk>&)=0; virtual ~IEncoder()=default; };
struct ITransport   { virtual bool send(const IEncoder::EncodedChunk&)=0; virtual ~ITransport()=default; };
```

**å…³é”®å¥‘çº¦ï¼ˆLSPï¼‰**ï¼š

- `grab()` ä¸æ”¹æ—¶åºï¼›å¤±è´¥è¿”å› false è®©ä¸Šæ¸¸é‡è¿ã€‚
- `process()` ä¸ä¿®æ”¹è¾“å…¥ï¼›`encode()` å•å¸§ 0~N åŒ…ä½†ä¿æŒ PTS å•è°ƒï¼›`send()` éé˜»å¡/çŸ­é˜»å¡ã€‚
- æ‰€æœ‰å®ç°**ä¸æŠ›å¼‚å¸¸**ï¼ˆè¿”å›å€¼è¡¨è¾¾é”™è¯¯ï¼‰ï¼Œä¿è¯å®æ—¶è·¯å¾„å¯æ§ã€‚

------

# Analyzer å®ç°è¦ç‚¹

- **é¢„å¤„ç†**ï¼šLetterboxï¼ˆç¼©æ”¾+å¡«å……ï¼Œè®°å½• `scale/pad` ä»¥ä¾¿åæŠ•å½±ï¼‰ã€BGRâ†’RGBã€Normalizeã€NCHWï¼›æ¨èåœ¨ **CUDA/NPP** ä¸Šåšå¹¶ç›´æ¥äº§å‡º **GPU Tensor**ã€‚éšåç”¨ **IOBinding** å°†è¿™å—æ˜¾å­˜ç»‘å®šä¸º ORT è¾“å…¥ï¼Œé¿å… CPUâ†”GPU æ‹·è´ã€‚[onnxruntime.ai](https://onnxruntime.ai/docs/performance/tune-performance/iobinding.html?utm_source=chatgpt.com)
- **æ¨ç†ä¼šè¯ï¼ˆONNX Runtimeï¼‰**ï¼š
  - åˆ›å»º `Ort::Session` æ—¶æ ¹æ®å…¨å±€ EPï¼ˆEngineManagerï¼‰è¿½åŠ  **CUDA** æˆ– **TensorRT** Providerï¼›ä¹Ÿå¯å›è½ CPUã€‚[onnxruntime.ai+1](https://onnxruntime.ai/docs/execution-providers/CUDA-ExecutionProvider.html?utm_source=chatgpt.com)
  - ç”¨ `Ort::IoBinding` é¢„ç»‘å®šè¾“å…¥/è¾“å‡ºå¼ é‡ï¼ˆGPUï¼‰ï¼Œ`Run()` ä¸å†éšå¼æ‹·è´ã€‚[onnxruntime.ai](https://onnxruntime.ai/docs/api/c/struct_ort_1_1_io_binding.html?utm_source=chatgpt.com)
- **åå¤„ç†**ï¼š
  - **YOLO-det**ï¼šè§£ç é¢„æµ‹ â†’ conf åˆç­› â†’ **IoU NMS**ï¼›é˜ˆå€¼ï¼ˆ`conf`ã€`iou`ï¼‰ä½œä¸ºçƒ­æ›´æ–°å‚æ•°ï¼Œæ˜¯ç²¾åº¦/å¬å›/é‡å æ§åˆ¶çš„å…³é”®æ—‹é’®ã€‚[docs.ultralytics.com+1](https://docs.ultralytics.com/modes/predict/?utm_source=chatgpt.com)
  - **YOLO-seg**ï¼šæ¯æ¡†ç³»æ•° * åŸå‹ï¼ˆprotosï¼‰åˆæˆæ©ç  â†’ è£å‰ª/ä¸Šé‡‡æ · â†’ é˜ˆå€¼åŒ–ã€‚
  - **DETR**ï¼šå– logits ä¸ boxes å¹¶åå½’ä¸€åŒ–ï¼›**é€šå¸¸ä¸åš NMS**ï¼ˆset prediction + åŒˆç‰™åˆ©åŒ¹é…ï¼‰ã€‚[learnopencv.com](https://learnopencv.com/detr-overview-and-inference/?utm_source=chatgpt.com)
- **æ¸²æŸ“**ï¼šå¯ç”»æ¡†/æ©ç ï¼›æˆ–è¾“å‡º JSON ç”±å‰ç«¯æœ¬åœ°å åŠ ï¼ˆè¿›ä¸€æ­¥çœç¼–ç æˆæœ¬ï¼‰ã€‚

------

# å¼•æ“ç®¡ç†ï¼ˆå…¨å±€ EP åˆ‡æ¢ï¼‰

```
struct EngineSpec { std::string ep="ort-cuda"; int device=0; /* trt_fp16, workspace_mb... */ };
class EngineManager {
public:
  EngineSpec current() const;
  void set(const EngineSpec&); // è¿›å…¥è¿ç§»æ€ï¼šåˆ—ä¸¾åœ¨ç”¨æ¨¡å‹ â†’ å¹¶è¡Œå»ºæ–°Session(æ–°EP)å¹¶é¢„çƒ­ â†’ åˆ†æ‰¹åŸå­åˆ‡ â†’ å›æ”¶æ—§
  std::shared_ptr<IModelSession> make_session(const std::string& onnx, int in_w, int in_h) const;
};
```

> ORT çš„ Execution Provider æ˜¯é€šè¿‡ `SessionOptions` è¿½åŠ ï¼›CUDA ä¸ TensorRT çš„å®˜æ–¹æ–‡æ¡£è¯¦è¿°å®‰è£…/çº¦æŸã€‚[onnxruntime.ai+1](https://onnxruntime.ai/docs/execution-providers/CUDA-ExecutionProvider.html?utm_source=chatgpt.com)
>  å¦‚æœä½ ä¹Ÿä¼šç”¨åˆ°åŸç”Ÿ TensorRTï¼Œå¼•æ“å¯å¤š context å¹¶å‘ï¼Œä½†**ä¸è¦è·¨çº¿ç¨‹å…±äº«åŒä¸€ä¸ª ExecutionContext**ï¼ˆçº¿ç¨‹å®‰å…¨è®¨è®ºä¸å®˜æ–¹æ¶æ„æ–‡æ¡£éƒ½æœ‰æé†’ï¼‰ã€‚[NVIDIA Docs+1](https://docs.nvidia.com/deeplearning/tensorrt/latest/architecture/how-trt-works.html?utm_source=chatgpt.com)

------

# Pipeline ä¸æŒ‰éœ€ç”Ÿäº§

- `Pipeline` å†…éƒ¨æŒ‰é˜¶æ®µï¼ˆDecode/Analyze/Encodeï¼‰ä¸²æ¥ï¼Œæœ‰**å°å‹æœ‰ç•Œé˜Ÿåˆ—**åšè§£è€¦ï¼›æ‹¥å¡æ—¶é‡‡å–â€œ**ä¸¢æ—§ä¿æ–°**â€ã€‚
- `TrackManager` ä»¥ `(stream, profile)` ä¸º keyï¼š
  - `POST /subscribe`ï¼šè‹¥ä¸å­˜åœ¨åˆ™ç”¨ Builder åˆ›å»ºå¹¶ `start()`ï¼Œå¼•ç”¨è®¡æ•°+1ï¼›è¿”å› WHEP/WHIP ç«¯ç‚¹ã€‚
  - `POST /unsubscribe`ï¼šå¼•ç”¨-1ï¼›ç©ºé—²è¶…æ—¶ï¼ˆå¦‚ 60sï¼‰å›æ”¶ã€‚
  - åˆ‡æ¢æ¥å£ï¼šè°ƒç”¨ `ISwitchableSource::switch_to()`ã€`Analyzer::swap_*()` å®ç°å¹³æ»‘çƒ­æ’æ‹”ã€‚

------

# REST æ§åˆ¶é¢ï¼ˆç¨³å®šåè®®ï¼‰

- `POST /subscribe`
   `{"stream":"camA","profile":"det_720p","init_url":"rtsp://...","onnx":"/models/yolov8n.onnx"}`
   â†’ `{"whep":"http://<sfu>/camA_det_720p/whep"}`
- `POST /unsubscribe`  `{"stream":"camA","profile":"det_720p"}`
- `POST /source/switch` `{"stream":"camA","profile":"det_720p","url":"rtsp://..."}`ï¼ˆ**é¢„çƒ­æˆåŠŸ**ååŸå­æ›¿æ¢ï¼‰
- `POST /model/switch`  `{"stream":"camA","profile":"det_720p","onnx":"/models/yolov12x.onnx"}`ï¼ˆ**é¢„çƒ­æ–°ä¼šè¯**â†’åŸå­æ›¿æ¢ï¼‰
- `POST /task/switch`   `{"stream":"camA","profile":"det_720p","task":"seg"}`ï¼ˆæ›¿æ¢åå¤„ç†/æ¸²æŸ“å™¨ï¼›å¿…è¦æ—¶é™„å¸¦æ–° onnxï¼‰
- `PATCH /model/params` `{"stream":"camA","profile":"det_720p","params":{"conf":0.35,"iou":0.55}}`ï¼ˆ**æ— é”å¿«ç…§**å³æ—¶ç”Ÿæ•ˆï¼‰
- `POST /engine/set`    `{"engine":"ort-tensorrt","device":0,"options":{"trt_fp16":true}}`ï¼ˆ**æ‰¹é‡é¢„çƒ­â†’åˆ†æ‰¹A/B**ï¼‰

------

# é…ç½®æ–‡ä»¶ï¼ˆå¼€ç®±å³ç”¨ï¼‰

**`config/app.yaml`**

```c++
engine: { type: ort-cuda, device: 0, options: { trt_fp16: true, trt_workspace_mb: 2048 } }
sfu:    { whip_base: "http://mediamtx:8889", whep_base: "http://mediamtx:8889" }
orchestration: { idle_timeout_ms: 60000, reap_interval_ms: 5000 }
defaults:
  decoder: { impl: ffmpeg, rtsp: { prefer_tcp: true, timeout_ms: 5000 } }
  encoder: { impl: ffmpeg_h264, w: 1280, h: 720, fps: 30, bitrate_kbps: 3500, gop: 60, bframes: 0, preset: veryfast, tune_zerolatency: true }
security:
  allowed_source_schemes: ["rtsp","rtsps"]
  switch_limits: { source_per_stream_per_sec: 0.2, model_per_stream_per_sec: 0.5 }
observability: { log_level: info, metrics: { prom_endpoint: "0.0.0.0:9090" } }
```

**`config/profiles.yaml`**

```yaml
profiles:
  det_720p:
    task: det
    model:   { family: yolo, onnx: "/models/yolov8n.onnx", input_w: 640, input_h: 640 }
    encoder: { w: 1280, h: 720, fps: 30, bitrate_kbps: 3500, gop: 60, bframes: 0 }
    publish: { whip_url_template: "${whip_base}/${stream}_det_720p/whip" }
  seg_720p:
    task: seg
    model:   { family: yolo, onnx: "/models/yolov8s-seg.onnx", input_w: 640, input_h: 640 }
    encoder: { w: 1280, h: 720, fps: 30, bitrate_kbps: 3500, gop: 60, bframes: 0 }
    publish: { whip_url_template: "${whip_base}/${stream}_seg_720p/whip" }
```

**`config/models.yaml`**

```yaml
models:
  det:
    yolo: { v12l: "/models/yolov12l.onnx", v12x: "/models/yolov12x.onnx", v8n: "/models/yolov8n.onnx" }
    transformer: { detr-r50: "/models/detr_resnet50.onnx", detr-r101: "/models/detr_resnet101.onnx" }
  seg:
    yolo: { v12s-seg: "/models/yolov12s-seg.onnx", v8s-seg: "/models/yolov8s-seg.onnx" }
```

**`config/analyzer_params.yaml`**

```yaml
params:
  det: { conf: 0.25, iou: 0.50, classes: "all", roi: null }
  seg: { conf: 0.25, iou: 0.50, mask_thresh: 0.5 }
```

------

# å…³é”®å®ç°ç»†èŠ‚ï¼ˆä¸€æ­¥åˆ°ä½ï¼‰

## FFmpeg è§£ç /ç¼–ç ï¼ˆsend/receiveï¼‰

- **è§£ç **ï¼š`avformat_open_input`â†’`avformat_find_stream_info`â†’`avcodec_open2`ï¼›å¾ªç¯ä¸­ `av_read_frame`â†’`avcodec_send_packet`â†’`avcodec_receive_frame`â†’ï¼ˆå¿…è¦æ—¶ `sws_scale` è½¬ BGR æˆ– NV12ï¼‰ã€‚[ffmpeg.org](https://ffmpeg.org/doxygen/4.0/group__lavc__decoding.html?utm_source=chatgpt.com)
- **ç¼–ç **ï¼šé…ç½® x264/NVENCï¼ˆä½å»¶è¿Ÿå»ºè®® `bframes=0`ã€`tune=zerolatency`ã€åˆç† GOPï¼‰ï¼›`avcodec_send_frame`â†’å¾ªç¯ `avcodec_receive_packet` ç›´åˆ° `EAGAIN/EOF`ã€‚[ffmpeg.org](https://www.ffmpeg.org/doxygen/4.1/group__lavc__encdec.html?utm_source=chatgpt.com)

## ONNX Runtimeï¼ˆEP + IOBindingï¼‰

- **EP**ï¼šé€šè¿‡ `SessionOptions` é™„åŠ  **CUDA** æˆ– **TensorRT** Providerï¼›åœ¨ç›¸åŒç¡¬ä»¶ä¸Š TensorRT EP å¸¸å¸¦æ¥æ›´å¥½çš„åå/æ—¶å»¶ï¼ˆå–å†³äºæ¨¡å‹/å¹³å°ï¼‰ã€‚[onnxruntime.ai+1](https://onnxruntime.ai/docs/execution-providers/CUDA-ExecutionProvider.html?utm_source=chatgpt.com)
- **IOBinding**ï¼šæå‰æŠŠè¾“å…¥/è¾“å‡ºçš„è®¾å¤‡ç¼“å†²åŒºç»‘å®šåˆ°ä¼šè¯ï¼Œ`Run()` æœŸé—´é¿å…éšå¼æ‹·è´ï¼Œæ˜¯å®æ—¶åœºæ™¯é™æ—¶å»¶çš„å…³é”®ã€‚[onnxruntime.ai](https://onnxruntime.ai/docs/performance/tune-performance/iobinding.html?utm_source=chatgpt.com)

## åå¤„ç†ä¸å‚æ•°

- **YOLO**ï¼šæš´éœ² `conf/iou/classes` å¯è°ƒï¼›Ultralytics æ–‡æ¡£æ˜ç¡®è¿™äº›å‚æ•°æ§åˆ¶é¢„æµ‹é˜ˆå€¼ä¸ NMS è¡Œä¸ºã€‚[docs.ultralytics.com+1](https://docs.ultralytics.com/modes/predict/?utm_source=chatgpt.com)
- **DETR**ï¼šå¸¸è§„ä¸åš NMSï¼Œç›´æ¥é˜ˆå€¼ä¸åæŠ•å½±å³å¯ã€‚[learnopencv.com](https://learnopencv.com/detr-overview-and-inference/?utm_source=chatgpt.com)

## å¹¶å‘ä¸ä¸Šä¸‹æ–‡

- **çº¿ç¨‹æ¨¡å‹**ï¼šè§£ç /æ¨ç†/ç¼–ç ä¸‰æ®µä¸²æ¥ï¼Œæœ‰ç•Œé˜Ÿåˆ—ï¼›æ‹¥å¡ä¸¢æ—§ä¿æ–°ã€‚
- **TensorRTï¼ˆå¦‚ä½¿ç”¨åŸç”Ÿï¼‰**ï¼š**æ¯çº¿ç¨‹ä¸€ä¸ª ExecutionContext** æ›´å®‰å…¨ï¼Œé¿å…å…±äº« context çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼›å®˜æ–¹æ–‡æ¡£/ç¤¾åŒºå‡æœ‰æé†’ã€‚[NVIDIA Docs+1](https://docs.nvidia.com/deeplearning/tensorrt/latest/architecture/how-trt-works.html?utm_source=chatgpt.com)
## ÊµÊ©½øÕ¹£¨2025-10-01£©

- **ÊµÊ±¹ÜÏß**£ºPipeline ÒÑ½ÓÈë VideoAnalyzer£¬Ö¡¼¶»Øµ÷Ö±½Ó´¥·¢ÍÆÀí£¬ÒıÈë½âÂëÖØÊÔÓëÖ¸ÊıÍË±Ü£¬Ö§³ÖÒì³£ÈÕÖ¾¡£
- **ÔËĞĞÖ¸±ê**£º/api/system/stats ·µ»Øµ±Ç°Ã¿ÌõÁ÷µÄ FPS¡¢Æ½¾ùÑÓ³Ù¡¢Ô¤ÈÈ×´Ì¬£¬±ãÓÚÇ°¶Ë»òÔËÎ¬Ãæ°å¹Û²â¡£
- **Ä£ĞÍÅäÖÃ**£ºÖ§³Ö¼ì²âÓë·Ö¸îÄ£ĞÍµÄÍ³Ò»¼ÓÔØÓëÇĞ»»£¬ÅäÖÃÎÄ¼ş¿É°´ task/family/variant ×éÖ¯£¬¶àÄ£ĞÍÏÂÀ­ÊµÏÖ¶¯Ì¬ÇĞ»»¡£
